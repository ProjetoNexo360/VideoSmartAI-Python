# docker-compose.full.yaml - Stack completo para desenvolvimento local
# Inclui: VideoSmartAI API, Evolution API, PostgreSQL e Redis
# Execute: docker-compose -f docker-compose.full.yaml up

version: "3.9"

services:
  # ============================================
  # PostgreSQL
  # ============================================
  postgres:
    image: postgres:15
    container_name: videosmartai_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: videosmartai
      POSTGRES_USER: videosmartai
      POSTGRES_PASSWORD: videosmartai123
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U videosmartai -d videosmartai"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - videosmartai-network

  # ============================================
  # Redis
  # ============================================
  redis:
    image: redis:7
    container_name: videosmartai_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redisdata:/data
    networks:
      - videosmartai-network

  # ============================================
  # Evolution API
  # ============================================
  evolution-api:
    image: atendai/evolution-api:latest
    container_name: videosmartai_evolution
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "8080:8080"
    environment:
      # ===== API =====
      SERVER_PORT: 8080
      AUTHENTICATION_API_KEY: ">q-HN0pPZ#.#3l2rO+@NKQKmH-^7y)ZH.y0cOFKxbo%)}iLV1Wb1H*Qw{M!vd|<+"
      
      # ===== Banco de dados =====
      DATABASE_ENABLED: "true"
      DATABASE_PROVIDER: "postgresql"
      DATABASE_CONNECTION_URI: "postgresql://videosmartai:videosmartai123@postgres:5432/videosmartai"
      DATABASE_SAVE_DATA_INSTANCE: "true"
      DATABASE_SAVE_DATA_NEW_MESSAGE: "true"
      DATABASE_SAVE_MESSAGE_UPDATE: "true"
      DATABASE_SAVE_DATA_CONTACTS: "true"
      DATABASE_SAVE_DATA_CHATS: "true"
      DATABASE_SAVE_DATA_LABELS: "true"
      DATABASE_SAVE_DATA_HISTORIC: "true"
      
      # ===== Redis Cache =====
      CACHE_LOCAL_ENABLED: "false"
      CACHE_REDIS_ENABLED: "true"
      CACHE_REDIS_URI: "redis://redis:6379/2"
      CACHE_REDIS_TTL: "604800"
      CONFIG_SESSION_PHONE_VERSION: 2.3000.1026354025
      
      NODE_ENV: production
    volumes:
      - evolution_instances:/evolution/instances
    networks:
      - videosmartai-network

  # ============================================
  # VideoSmartAI API
  # ============================================
  videosmartai-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: videosmartai_api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      evolution-api:
        condition: service_started
    ports:
      - "8000:8000"
    environment:
      # Database
      DATABASE_URL: "postgresql+psycopg://videosmartai:videosmartai123@postgres:5432/videosmartai"
      
      # Redis
      REDIS_URL: "redis://redis:6379"
      
      # Evolution API
      EVO_BASE: "http://evolution-api:8080"
      EVO_APIKEY: ">q-HN0pPZ#.#3l2rO+@NKQKmH-^7y)ZH.y0cOFKxbo%)}iLV1Wb1H*Qw{M!vd|<+"
      EVO_INSTANCE: "default"
      EVO_INTEGRATION: "WHATSAPP-BAILEYS"
      
      # Outras variáveis (configure conforme necessário)
      JWT_SECRET: "change-me-in-production-use-strong-secret"
      HTTP_TIMEOUT: "120.0"
      PALAVRAS_ANTES: "2"
      PALAVRAS_DEPOIS: "0"
      AJUSTE_MS: "150"
      HEYGEN_MIN_VIDEO_DURATION: "5.0"
      
      # ElevenLabs (configure suas credenciais)
      ELEVEN_NODE_API: "https://api-elevenlabs-nodejs.onrender.com/api"
      ELEVEN_API_NAMESPACE: "/elevenlabs"
      ELEVEN_AUTH_URL: "https://api-elevenlabs-nodejs.onrender.com/api/auth/login"
      ELEVEN_USERNAME: ""
      ELEVEN_PASSWORD: ""
      
      # Heygen (configure suas credenciais)
      HEYGEN_NODE_API: "https://api-heygen-nodejs.onrender.com/api"
      HEYGEN_API_NAMESPACE: ""
      HEYGEN_AUTH_URL: "https://api-heygen-nodejs.onrender.com/api/auth/login"
      HEYGEN_USERNAME: ""
      HEYGEN_PASSWORD: ""
      HEYGEN_DEBUG: "1"
      
      # Webhook
      WEBHOOK_URL: "https://webhook.site/150557f8-3946-478e-8013-d5fedf0e56f2"
      
      # Automação API
      AUTOMATION_API_BASE: "http://localhost:3000"
      
      PORT: "8000"
    volumes:
      - ./:/app
    networks:
      - videosmartai-network

volumes:
  pgdata:
  redisdata:
  evolution_instances:

networks:
  videosmartai-network:
    driver: bridge

